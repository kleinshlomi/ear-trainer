<!doctype html>
<html lang="en" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ear Trainer - Multi Mode</title>
  <style>
    body { font-family: system-ui, Arial; padding: 20px; max-width: 820px; margin: auto; }
    button { padding: 10px 14px; margin: 6px 6px 6px 0; font-size: 16px; }
    .row { margin-top: 10px; }
    .tabs { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
    .tab { padding: 10px 14px; border: 1px solid #aaa; border-radius: 10px; cursor: pointer; user-select: none; }
    .tab.active { font-weight: 800; }
    .panel { display: none; }
    .panel.active { display: block; }
    #status { margin-top: 12px; font-weight: 800; }
    #score { margin-top: 8px; }
    #bigAnswer { margin-top: 18px; font-size: 54px; font-weight: 900; text-align: center; min-height: 64px; }
    .small { font-size: 13px; opacity: 0.85; line-height: 1.35; }
    kbd { padding: 2px 6px; border: 1px solid #aaa; border-radius: 6px; font-family: ui-monospace, Menlo, monospace; }
    input[type="range"] { width: 260px; }
    label { display: block; margin-top: 10px; }

    .answersRow {
      display: flex;
      direction: ltr;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .answersRow button { min-width: 64px; }
  </style>
</head>
<body>

  <h2>Ear Trainer - Modes</h2>

  <div class="tabs">
    <div class="tab active" id="tabThirds">1) Major/Minor Third</div>
    <div class="tab" id="tabDegrees">2) Scale Degrees in C</div>
  </div>

  <div class="small">
    Quick switch: <kbd>1</kbd> thirds, <kbd>2</kbd> degrees. System shortcuts are not intercepted.
  </div>

  <hr />

  <section class="panel active" id="panelThirds">
    <h3>Mode 1: Major vs Minor Third (Random Root)</h3>

    <div class="row">
      <button id="playBtn">Play Random</button>
      <button id="replayBtn">Replay (R)</button>
    </div>

    <div class="row">
      <button id="majorBtn" disabled>Major</button>
      <button id="minorBtn" disabled>Minor</button>
    </div>

    <label>
      <input type="checkbox" id="asChord" />
      Play as chord (simultaneous). If unchecked: short arpeggio.
    </label>

    <label>
      <input type="checkbox" id="randomStyle" />
      Auto style: random chord vs arpeggio on each play.
    </label>

    <div class="row">
      <button id="toggleRandomStyleBtn">Toggle Auto Style</button>
    </div>

    <label>
      Root range: <span id="rangeLabel"></span>
      <div class="small">Tip: keep mid range for comfort.</div>
      <input id="lowNote" type="range" min="48" max="72" step="1" value="55" />
      <input id="highNote" type="range" min="48" max="72" step="1" value="67" />
    </label>

    <label>
      <input type="checkbox" id="avoidBlackRoot" />
      Prefer white-key roots only
    </label>

    <div class="small" style="margin-top:10px;">
      Shortcuts (Mode 1): <kbd>Space</kbd> play, <kbd>R</kbd> replay,
      Major: <kbd>M</kbd> or <kbd>F</kbd>, Minor: <kbd>N</kbd> or <kbd>D</kbd>.
    </div>
  </section>

  <section class="panel" id="panelDegrees">
    <h3>Mode 2: Scale Degrees in C Major (1–7)</h3>

    <div class="row">
      <button id="degPlayBtn">Play Random Note</button>
      <button id="degReplayBtn">Replay (R)</button>
      <button id="playTonicBtn">Play Tonic C (Reference)</button>
    </div>

    <div class="row answersRow" id="degAnswers"></div>

    <div class="small">
      Shortcuts (Mode 2): <kbd>Space</kbd> play, <kbd>R</kbd> replay,
      <kbd>C</kbd> tonic reference, <kbd>1</kbd>..<kbd>7</kbd> answer.
    </div>
  </section>

  <div id="status">Ready.</div>
  <div id="score">Score: <span id="ok">0</span> / <span id="total">0</span></div>
  <div id="bigAnswer"></div>

<script>
/* ---------- Audio (fixed: resume/unlock) ---------- */
let audioCtx = null;

function getCtx() {
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  return audioCtx;
}

async function ensureAudio() {
  const ctx = getCtx();
  if (ctx.state === "suspended") {
    try { await ctx.resume(); } catch (_) {}
  }
  return ctx;
}

function midiToFreq(m) { return 440 * Math.pow(2, (m - 69) / 12); }

async function playTone(freq, when, dur, gain = 0.12) {
  const ctx = await ensureAudio();
  const osc = ctx.createOscillator();
  const g = ctx.createGain();

  osc.type = "sine";
  osc.frequency.setValueAtTime(freq, when);

  g.gain.setValueAtTime(0.0001, when);
  g.gain.linearRampToValueAtTime(gain, when + 0.01);
  g.gain.linearRampToValueAtTime(0.0001, when + dur);

  osc.connect(g).connect(ctx.destination);
  osc.start(when);
  osc.stop(when + dur + 0.03);
}

async function playTwoTonesSimul(f1, f2) {
  const ctx = await ensureAudio();
  const now = ctx.currentTime + 0.02;
  playTone(f1, now, 0.85);
  playTone(f2, now, 0.85);
}

async function playTwoTonesArp(f1, f2) {
  const ctx = await ensureAudio();
  const now = ctx.currentTime + 0.02;
  playTone(f1, now, 0.45);
  playTone(f2, now + 0.18, 0.60);
}

/* ---------- Global UI/State ---------- */
const statusEl = document.getElementById("status");
const okEl = document.getElementById("ok");
const totalEl = document.getElementById("total");
const bigAnswerEl = document.getElementById("bigAnswer");

let ok = 0, total = 0;
function setBigAnswer(text) { bigAnswerEl.textContent = text || ""; }
function bumpScore(isCorrect) {
  total++;
  if (isCorrect) ok++;
  okEl.textContent = String(ok);
  totalEl.textContent = String(total);
}

/* ---------- Navigation (Tabs) ---------- */
const tabThirds = document.getElementById("tabThirds");
const tabDegrees = document.getElementById("tabDegrees");
const panelThirds = document.getElementById("panelThirds");
const panelDegrees = document.getElementById("panelDegrees");

let activeMode = "thirds";

function setMode(mode) {
  activeMode = mode;
  tabThirds.classList.toggle("active", mode === "thirds");
  tabDegrees.classList.toggle("active", mode === "degrees");
  panelThirds.classList.toggle("active", mode === "thirds");
  panelDegrees.classList.toggle("active", mode === "degrees");
  setBigAnswer("");
  statusEl.textContent = (mode === "thirds") ? "Mode: Thirds." : "Mode: Degrees.";
}

tabThirds.addEventListener("click", () => setMode("thirds"));
tabDegrees.addEventListener("click", () => setMode("degrees"));

/* ---------- Mode 1: Thirds ---------- */
const playBtn = document.getElementById("playBtn");
const replayBtn = document.getElementById("replayBtn");
const majorBtn = document.getElementById("majorBtn");
const minorBtn = document.getElementById("minorBtn");
const asChordChk = document.getElementById("asChord");
const randomStyleChk = document.getElementById("randomStyle");
const toggleRandomStyleBtn = document.getElementById("toggleRandomStyleBtn");
const lowNote = document.getElementById("lowNote");
const highNote = document.getElementById("highNote");
const rangeLabel = document.getElementById("rangeLabel");
const avoidBlackRoot = document.getElementById("avoidBlackRoot");

let thirds_root = null;
let thirds_isMajor = null;

function isWhiteKey(midi) {
  const pc = ((midi % 12) + 12) % 12;
  return ![1,3,6,8,10].includes(pc);
}
function clamp(n, lo, hi) { return Math.max(lo, Math.min(hi, n)); }
function randInt(lo, hi) { return lo + Math.floor(Math.random() * (hi - lo + 1)); }

function pickRandomRoot(low, high, whiteOnly) {
  low = clamp(low, 24, 96);
  high = clamp(high, 24, 96);
  if (high < low) [low, high] = [high, low];
  const maxRoot = high - 4;
  const minRoot = low;
  if (maxRoot < minRoot) return 60;
  if (!whiteOnly) return randInt(minRoot, maxRoot);
  for (let i = 0; i < 30; i++) {
    const m = randInt(minRoot, maxRoot);
    if (isWhiteKey(m)) return m;
  }
  return randInt(minRoot, maxRoot);
}

function midiName(m) {
  const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  const pc = ((m % 12) + 12) % 12;
  const oct = Math.floor(m / 12) - 1;
  return names[pc] + oct;
}

function updateRangeLabel() {
  const lo = Number(lowNote.value);
  const hi = Number(highNote.value);
  const a = Math.min(lo, hi);
  const b = Math.max(lo, hi);
  rangeLabel.textContent = `${midiName(a)} to ${midiName(b)}`;
}
lowNote.addEventListener("input", updateRangeLabel);
highNote.addEventListener("input", updateRangeLabel);
updateRangeLabel();

function chooseAsChordNow() {
  if (randomStyleChk.checked) return Math.random() < 0.5;
  return asChordChk.checked;
}

async function thirds_playCurrent() {
  if (thirds_root === null || thirds_isMajor === null) return;
  const rootFreq = midiToFreq(thirds_root);
  const thirdFreq = midiToFreq(thirds_root + (thirds_isMajor ? 4 : 3));
  const asChordNow = chooseAsChordNow();
  if (asChordNow) await playTwoTonesSimul(rootFreq, thirdFreq);
  else await playTwoTonesArp(rootFreq, thirdFreq);
  statusEl.textContent = `Heard (${asChordNow ? "chord" : "arpeggio"}) -> answer Major/Minor.`;
}

async function thirds_newRound() {
  thirds_root = pickRandomRoot(Number(lowNote.value), Number(highNote.value), avoidBlackRoot.checked);
  thirds_isMajor = Math.random() < 0.5;
  majorBtn.disabled = false;
  minorBtn.disabled = false;
  setBigAnswer("");
  await thirds_playCurrent();
}

async function thirds_replayOrStart() {
  if (thirds_root === null || thirds_isMajor === null) { await thirds_newRound(); return; }
  await thirds_playCurrent();
}

function thirds_answer(userSaysMajor) {
  if (thirds_isMajor === null) return;
  const correct = (userSaysMajor === thirds_isMajor);
  bumpScore(correct);
  statusEl.textContent = correct ? "Correct." : "Wrong.";
  setBigAnswer(thirds_isMajor ? "MAJOR" : "MINOR");
  majorBtn.disabled = true;
  minorBtn.disabled = true;
}

function updateRandomStyleUI() {
  toggleRandomStyleBtn.textContent = randomStyleChk.checked ? "Auto style: ON" : "Auto style: OFF";
}
toggleRandomStyleBtn.addEventListener("click", () => {
  randomStyleChk.checked = !randomStyleChk.checked;
  updateRandomStyleUI();
});
randomStyleChk.addEventListener("change", updateRandomStyleUI);
updateRandomStyleUI();

playBtn.addEventListener("click", () => { if (activeMode==="thirds") thirds_newRound(); });
replayBtn.addEventListener("click", () => { if (activeMode==="thirds") thirds_replayOrStart(); });
majorBtn.addEventListener("click", () => thirds_answer(true));
minorBtn.addEventListener("click", () => thirds_answer(false));

/* ---------- Mode 2: Degrees in C ---------- */
const degPlayBtn = document.getElementById("degPlayBtn");
const degReplayBtn = document.getElementById("degReplayBtn");
const playTonicBtn = document.getElementById("playTonicBtn");
const degAnswers = document.getElementById("degAnswers");

const DEGREE_PCS = [0, 2, 4, 5, 7, 9, 11];
const TONIC_MIDI = 60;

let deg_degree = null;
let deg_midi = null;

function degrees_buildButtons() {
  for (let i = 1; i <= 7; i++) {
    const b = document.createElement("button");
    b.textContent = String(i);
    b.dataset.degree = String(i);
    b.addEventListener("click", () => degrees_answer(i));
    degAnswers.appendChild(b);
  }
}
degrees_buildButtons();

function degrees_setAnswerButtonsEnabled(enabled) {
  const btns = degAnswers.querySelectorAll("button");
  btns.forEach(b => b.disabled = !enabled);
}

async function degrees_playTonic() {
  const ctx = await ensureAudio();
  const now = ctx.currentTime + 0.02;
  await playTone(midiToFreq(TONIC_MIDI), now, 0.8, 0.14);
  statusEl.textContent = "Played tonic C (reference).";
}

async function degrees_playCurrent() {
  if (deg_midi === null) return;
  const ctx = await ensureAudio();
  const now = ctx.currentTime + 0.02;
  await playTone(midiToFreq(deg_midi), now, 0.9, 0.14);
  statusEl.textContent = "Heard -> which degree (1-7)?";
}

async function degrees_newRound() {
  deg_degree = 1 + Math.floor(Math.random() * 7);
  const octaveShift = (Math.random() < 0.5) ? -12 : +12;
  const pcOffset = DEGREE_PCS[deg_degree - 1];
  deg_midi = TONIC_MIDI + pcOffset + octaveShift;

  degrees_setAnswerButtonsEnabled(true);
  setBigAnswer("");
  await degrees_playCurrent();
}

async function degrees_replayOrStart() {
  if (deg_midi === null) { await degrees_newRound(); return; }
  await degrees_playCurrent();
}

function degrees_answer(userDegree) {
  if (deg_degree === null) return;
  const correct = (userDegree === deg_degree);
  bumpScore(correct);
  statusEl.textContent = correct ? "Correct." : "Wrong.";
  setBigAnswer(String(deg_degree));
  degrees_setAnswerButtonsEnabled(false);
}

degPlayBtn.addEventListener("click", () => { if (activeMode==="degrees") degrees_newRound(); });
degReplayBtn.addEventListener("click", () => { if (activeMode==="degrees") degrees_replayOrStart(); });
playTonicBtn.addEventListener("click", () => { if (activeMode==="degrees") degrees_playTonic(); });

/* ---------- Keyboard Shortcuts ---------- */
window.addEventListener("keydown", (e) => {
  if (e.metaKey || e.ctrlKey || e.altKey) return;

  const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
  if (tag === "input" || tag === "textarea" || tag === "select") return;

  const key = e.key;

  if (key === "1") { setMode("thirds"); return; }
  if (key === "2") { setMode("degrees"); return; }

  if (key === " ") {
    e.preventDefault();
    if (activeMode === "thirds") thirds_newRound();
    else degrees_newRound();
    return;
  }

  if (key === "r" || key === "R" || key === "ר") {
    e.preventDefault();
    if (activeMode === "thirds") thirds_replayOrStart();
    else degrees_replayOrStart();
    return;
  }

  if (activeMode === "thirds") {
    // Major: M or F (and Hebrew equivalents often produced by those keys)
    if (key === "m" || key === "M" || key === "f" || key === "F" || key === "צ" || key === "כ") {
      e.preventDefault();
      if (!majorBtn.disabled) thirds_answer(true);
      return;
    }
    // Minor: N or D
    if (key === "n" || key === "N" || key === "d" || key === "D" || key === "מ" || key === "ג") {
      e.preventDefault();
      if (!minorBtn.disabled) thirds_answer(false);
      return;
    }
  } else {
    if (/^[1-7]$/.test(key)) {
      const d = Number(key);
      const btn = degAnswers.querySelector(`button[data-degree="${d}"]`);
      if (btn && !btn.disabled) degrees_answer(d);
      return;
    }
    if (key === "c" || key === "C" || key === "ב") {
      e.preventDefault();
      degrees_playTonic();
      return;
    }
  }
});
</script>

</body>
</html>